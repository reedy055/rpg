<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0B0F1A" />
  <title>LifeRPG</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="apple-touch-icon" href="assets/icon-192.png" />

  <!-- Styles -->
  <link rel="preload" href="styles.css" as="style" />
  <link rel="stylesheet" href="styles.css" />
  <style>body{background:#0B0F1A;color:#E6E9F2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}</style>
</head>
<body>
  <div id="app">
    <!-- Milestone/banner -->
    <div id="banner" class="banner hidden" role="status" aria-live="polite"></div>

    <!-- Header / Hero -->
    <header class="app-header">
      <div class="hero">
        <div class="points">
          <div class="points-label">Points Today</div>
          <div id="statPoints" class="points-value">0</div>

          <!-- Daily Goal bar -->
          <div class="xpbar">
            <div id="xpFill" style="width:0%"></div>
            <span id="goalGhostTick" class="goal-ghost" title="Last week‚Äôs same weekday"></span>
          </div>
          <div id="goalText" class="goal-text muted" aria-live="polite"></div>
        </div>

        <div class="pills">
          <button class="pill" id="pillStreak" data-nav="statsView" title="View stats">
            <span class="emoji">üî•</span><span id="statStreak">0</span>
          </button>
          <button class="pill" id="pillCoins" title="Open Shop">
            <span class="emoji">ü™ô</span><span id="statCoins">0</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="app-main">

      <!-- HOME -->
      <section id="homeView" class="view active" role="region" aria-label="Home">
        <!-- Today‚Äôs Tasks -->
        <div class="card" id="todaysTasksCard">
          <div class="card-head">
            <h3>Today‚Äôs Tasks</h3>
            <div class="row">
              <button id="btnAddTodoInline" class="btn small">+ Add</button>
              <!-- Overdue toggle removed by design. -->
            </div>
          </div>
          <div id="todaysTasksList" class="list">
            <div class="placeholder">You‚Äôre all caught up. Add a task for today or schedule one.</div>
          </div>
          <!-- Keep the block hidden so current JS doesn‚Äôt break before we change logic -->
          <div id="overdueBlock" class="list hidden" style="display:none"></div>
        </div>

        <!-- Daily Habits -->
        <div class="card" id="habitsCard">
          <div class="card-head">
            <h3>Daily Habits</h3>
            <button id="btnAddHabit" class="btn small">+ Add</button>
          </div>
          <div id="habitsList" class="list">
            <div class="placeholder">No habits yet. Add 1‚Äì3 to start your streak.</div>
          </div>
        </div>

        <!-- Daily Challenges -->
        <div class="card">
          <div class="card-head">
            <h3>Daily Challenges</h3>
          </div>
          <div id="dailyList" class="list three-cards">
            <div class="placeholder">Your challenges will appear here.</div>
          </div>
        </div>

        <!-- Weekly Boss -->
        <div class="card" id="bossCard">
          <div class="card-head"><h3>Weekly Boss</h3></div>
          <div class="boss-wrap">
            <canvas id="bossRing" width="220" height="220" aria-label="Weekly boss progress"></canvas>
            <div id="bossGoals" class="boss-goals">
              <div class="placeholder">Boss goals will appear here.</div>
            </div>
          </div>
        </div>

        <!-- Completed Today feed -->
        <div class="card" id="completedCard">
          <div class="card-head"><h3>Completed Today</h3></div>
          <div id="feedToday" class="list">
            <div class="placeholder">When you complete items, they‚Äôll appear here.</div>
          </div>
        </div>
      </section>

      <!-- CALENDAR -->
      <section id="calendarView" class="view" role="region" aria-label="Calendar">
        <div class="card">
          <div class="card-head row">
            <div class="row">
              <button id="calPrev" class="icon-btn" aria-label="Previous month">‚Äπ</button>
              <h3 id="calTitle">Month YYYY</h3>
              <button id="calNext" class="icon-btn" aria-label="Next month">‚Ä∫</button>
            </div>
            <button id="calToday" class="btn ghost small">Today</button>
          </div>
          <div id="monthHead" class="cal-head">
            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
          </div>
          <div id="monthGrid" class="cal-grid">
            <div class="placeholder">Calendar will render here.</div>
          </div>
        </div>
      </section>

      <!-- STATS -->
      <section id="statsView" class="view" role="region" aria-label="Stats">
        <!-- KPI chips injected by JS -->

        <div class="grid two">
          <div class="card">
            <div class="card-head"><h3>Streak</h3></div>
            <div class="streak-wrap">
              <div class="streak-badge"><span>üî•</span><span id="streakBig">0</span></div>
              <div class="streak-meta">
                <div>Best: <strong id="bestStreak">0</strong></div>
                <div>Completions/week: <strong id="cmpWeek">0</strong></div>
              </div>
            </div>
          </div>

          <!-- New: This Week micro-chart -->
          <div class="card">
            <div class="card-head"><h3>This Week</h3></div>
            <canvas id="weekChart" width="600" height="160" aria-label="This week bar chart"></canvas>
            <div id="weekDelta" class="muted" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-head"><h3>30-Day Points</h3></div>
          <canvas id="bar30" width="600" height="260" aria-label="30 day points bar chart"></canvas>
        </div>

        <!-- Per-Habit last 30 days rows -->
        <div class="card" id="habitHistoryCard">
          <div class="card-head"><h3>Habits ‚Äî Last 30 Days</h3></div>
          <div id="habitHistory" class="list">
            <div class="placeholder">Habits you add will show their daily history here.</div>
          </div>
        </div>
      </section>

      <!-- MANAGE -->
      <section id="manageView" class="view" role="region" aria-label="Manage">
        <!-- Task Library -->
        <div class="card">
          <div class="card-head">
            <h3>Task Library</h3>
            <button id="btnAddTask" class="btn small">+ Add</button>
          </div>
          <div id="manageTasks" class="list admin">
            <div class="placeholder">No items yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>

        <!-- Recurring Tasks (new manager) -->
        <div class="card">
          <div class="card-head">
            <h3>Recurring Tasks</h3>
            <button id="btnAddRule" class="btn small">+ Add Rule</button>
          </div>
          <div id="manageRecurrence" class="list admin">
            <div class="placeholder">Your weekday rules will appear here. You can edit or remove them.</div>
          </div>
        </div>

        <!-- Challenge Pool -->
        <div class="card">
          <div class="card-head">
            <h3>Challenge Pool</h3>
            <button id="btnAddChallenge" class="btn small">+ Add</button>
          </div>
          <div id="manageChallenges" class="list admin">
            <div class="placeholder">No challenges yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>

        <!-- Shop Items -->
        <div class="card">
          <div class="card-head">
            <h3>Shop</h3>
            <button id="btnAddShop" class="btn small">+ Add</button>
          </div>
          <div id="manageShop" class="list admin">
            <div class="placeholder">No rewards yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>

        <!-- Weekly Boss -->
        <div class="card">
          <div class="card-head">
            <h3>Boss Quest (Weekly)</h3>
            <!-- Keep templates for now so current JS doesn‚Äôt break; we‚Äôll remove in the JS chunk -->
            <div class="row">
              <button id="btnBossTemplate1" class="btn ghost small">Use ‚ÄúMomentum‚Äù</button>
              <button id="btnBossTemplate2" class="btn ghost small">Use ‚ÄúSocial‚Äù</button>
              <button id="btnBossReroll" class="btn small" title="Re-roll based on settings">Re-roll This Week</button>
            </div>
          </div>
          <div id="manageBoss" class="list admin">
            <div class="placeholder">Boss goals will auto-assign weekly. You can re-roll here.</div>
          </div>
        </div>

        <!-- Preferences -->
        <div class="card">
          <div class="card-head"><h3>Preferences</h3></div>
          <div class="form">
            <label>Daily Goal (points)
              <input id="inpDailyGoal" type="number" min="10" max="1000" value="60">
            </label>

            <label>Points per Coin
              <input id="inpPPC" type="number" min="10" max="1000" value="100">
            </label>

            <label>Daily Challenges (count)
              <input id="inpChallengesCount" type="number" min="0" max="10" value="3">
            </label>

            <label>Boss: Tasks per Week (auto-pick)
              <input id="inpBossTasksPerWeek" type="number" min="1" max="10" value="5">
            </label>

            <div class="row wrap">
              <label>Boss: Min times each
                <input id="inpBossMinTimes" type="number" min="1" max="14" value="2">
              </label>
              <label>Boss: Max times each
                <input id="inpBossMaxTimes" type="number" min="1" max="14" value="5">
              </label>
            </div>

            <label class="row">
              <input id="chkHaptics" type="checkbox" checked>
              <span>Haptics</span>
            </label>
            <p class="muted">Reset time is midnight (local). Made by <strong>Will Read</strong>.</p>
          </div>
        </div>

        <!-- Data -->
        <div class="card">
          <div class="card-head"><h3>Data</h3></div>
          <div class="row wrap">
            <button id="btnExport" class="btn ghost">Export JSON</button>
            <label class="file">
              <input id="fileImport" type="file" accept="application/json">
              <span class="btn">Import JSON</span>
            </label>
            <button id="btnWipe" class="btn danger">Wipe All Data</button>
          </div>
        </div>
      </section>

      <!-- Legacy settings stub (hidden) -->
      <section id="settingsView" class="view" role="region" aria-label="Settings" style="display:none">
        <div class="card"><div class="card-head"><h3>Legacy</h3></div>
          <p class="muted">Settings moved into Manage ‚Üí Preferences.</p>
        </div>
      </section>
    </main>

    <!-- Fixed Bottom Tab Bar -->
    <nav class="tabbar" role="tablist" aria-label="Primary">
      <button class="tab active" data-target="homeView" aria-selected="true" aria-label="Home">üè†</button>
      <button class="tab" data-target="calendarView" aria-label="Calendar">üìÖ</button>

      <button id="tabAdd" class="tab-plus" aria-label="Quick Add">+</button>

      <button class="tab" data-target="statsView" aria-label="Stats">üìà</button>
      <button class="tab" data-target="manageView" aria-label="Manage">üõ†Ô∏è</button>
    </nav>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Modal (forms) -->
    <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-card">
        <div class="modal-head">
          <h3 id="modalTitle">Modal</h3>
          <button id="modalClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-actions">
          <button id="modalCancel" class="btn ghost">Cancel</button>
          <button id="modalOk" class="btn">Save</button>
        </div>
      </div>
    </div>

    <!-- Quick Add Drawer ‚Äî with tabs -->
    <div id="drawerQuickAdd" class="drawer hidden" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
      <div class="drawer-card">
        <div class="drawer-head">
          <h3 id="qaTitle">Quick Add</h3>
          <button id="drawerQuickClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>

        <!-- Tabs -->
        <div class="row" style="gap:8px; padding:0 4px 8px 4px;">
          <button id="qaTabLib" class="btn small is-selected">Do from Library</button>
          <button id="qaTabToday" class="btn ghost small">New Today‚Äôs Task</button>
        </div>

        <!-- View A: Library -->
        <div id="qaViewLib">
          <div id="quickFavsRow" class="quick-row hidden">
            <div class="quick-title">Favorites</div>
            <div id="quickFavs" class="quick-chips"></div>
          </div>
          <div class="quick-title">All Tasks</div>
          <div id="quickTaskList" class="quick-grid">
            <div class="placeholder">Add tasks in Manage ‚Üí Task Library, then tap ‚ûï</div>
          </div>
        </div>

        <!-- View B: New Today‚Äôs Task (no time; weekday recurrence) -->
        <div id="qaViewToday" class="hidden" style="padding:6px 4px 2px 4px;">
          <div class="form">
            <label>Title
              <input id="qaTodoTitle" type="text" placeholder="e.g., Section 3 maths homework">
            </label>

            <label>Points
              <input id="qaTodoPoints" type="number" min="1" max="999" value="10">
            </label>

            <div>
              <div class="quick-title">Repeat on</div>
              <div id="qaWeekdays" class="row wrap">
                <button type="button" class="btn ghost small" data-wd="1">Mon</button>
                <button type="button" class="btn ghost small" data-wd="2">Tue</button>
                <button type="button" class="btn ghost small" data-wd="3">Wed</button>
                <button type="button" class="btn ghost small" data-wd="4">Thu</button>
                <button type="button" class="btn ghost small" data-wd="5">Fri</button>
                <button type="button" class="btn ghost small" data-wd="6">Sat</button>
                <button type="button" class="btn ghost small" data-wd="0">Sun</button>
              </div>
              <p class="muted" style="margin:6px 2px 0 2px;">Leave all unselected for a one-off today.</p>
            </div>

            <div class="row" style="justify-content:flex-end">
              <button id="qaCreateTodoBtn" class="btn">Add Task</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Shop Drawer -->
    <div id="drawerShop" class="drawer hidden" role="dialog" aria-modal="true" aria-labelledby="shopTitle">
      <div class="drawer-card">
        <div class="drawer-head">
          <h3 id="shopTitle">Shop</h3>
          <button id="drawerShopClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div id="shopDrawerList" class="shop-drawer-list">
          <div class="placeholder">No rewards yet. Add some in Manage ‚Üí Shop.</div>
        </div>
      </div>
    </div>

    <!-- Day Details Drawer (Calendar tap) -->
    <div id="drawerDayDetails" class="drawer hidden" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
      <div class="drawer-card">
        <div class="drawer-head">
          <h3 id="dayTitle">Day Details</h3>
          <button id="drawerDayClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div class="form" style="margin-bottom:10px">
          <div class="row wrap">
            <div class="pill"><span class="emoji">‚≠ê</span><span id="dayPts">0 pts</span></div>
            <div class="pill"><span class="emoji">ü™ô</span><span id="dayCoins">0 coins</span></div>
            <div class="pill"><span>‚úÖ</span><span id="dayCounts">0 tasks ‚Ä¢ 0 habits ‚Ä¢ 0 challenges</span></div>
          </div>
        </div>
        <div class="card" style="margin-bottom:0">
          <div class="card-head"><h3>What you did</h3></div>
          <div id="dayFeed" class="list">
            <div class="placeholder">Nothing logged for this day.</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script type="module">import "./app.js";</script>
  <script>
    // SW bootstrap
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});

    // Fallback tab wiring (center "+" is not a tab; wired in app.js)
    (function(){
      const tabs = document.querySelectorAll('.tabbar .tab');
      const views = document.querySelectorAll('.view');
      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const id = btn.getAttribute('data-target');
          views.forEach(v=>v.classList.toggle('active', v.id===id));
          const el = document.getElementById(id);
          if (el) { el.setAttribute('tabindex','-1'); el.focus({preventScroll:true}); }
        });
      });
    })();
  </script>
</body>
</html>
